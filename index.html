<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Butterfly Ledger ðŸ¦‹</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Consolas', monospace; color: white; user-select: none; }
        
        /* --- ANIMATIONS --- */
        @keyframes rainbow { 0% { color: red; } 20% { color: yellow; } 40% { color: green; } 60% { color: blue; } 80% { color: purple; } 100% { color: red; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- UI --- */
        .screen { position: fixed; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        
        #loader { display: flex; background: #000; z-index: 2000; }
        #progress-bar { width: 300px; height: 2px; background: #222; margin-top: 20px; }
        #progress-fill { width: 0%; height: 100%; background: #00d4ff; transition: width 0.1s; }

        #menu { display: none; z-index: 1000; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        #title { font-size: 4em; letter-spacing: 12px; margin-bottom: 0; text-shadow: 0 0 20px rgba(0,212,255,0.5); }
        .subtitle { font-size: 0.9em; color: #666; margin-bottom: 40px; }

        #roblox-promo { position: absolute; top: 30px; right: 30px; width: 220px; text-align: center; font-size: 0.8em; font-weight: bold; animation: rainbow 3s linear infinite, spin 10s linear infinite; }

        .main-btn { background: transparent; border: 1px solid #fff; color: #fff; padding: 12px 30px; cursor: pointer; font-size: 1.1em; transition: 0.3s; margin: 5px; pointer-events: auto; }
        .main-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }

        /* LOADOUTS */
        #loadout-screen { background: rgba(0,0,0,0.95); z-index: 1100; display: none; }
        #loadout-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .loadout-item { width: 450px; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); margin: 5px; }

        /* GAMEPLAY */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; padding: 40px; box-sizing: border-box; z-index: 10; pointer-events: none; flex-direction: column; justify-content: space-between; }
        .panel { pointer-events: auto; background: rgba(0,0,0,0.85); border: 1px solid #00d4ff; padding: 30px; }
        #outcome-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding: 20px; box-sizing: border-box; z-index: 50; }

        #pause-btn { pointer-events: auto; position: absolute; top: 30px; left: 30px; background: none; border: 1px solid #fff; color: #fff; width: 45px; height: 45px; cursor: pointer; font-size: 1.2em; z-index: 1000; }
        
        #music-container { position: absolute; left: -9999px; visibility: hidden; }
    </style>
</head>
<body>

    <div id="music-container">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&mute=0&loop=1&playlist=jfKfPfyJRdk" frameborder="0" allow="autoplay"></iframe>
    </div>

    <div id="loader" class="screen">
        <div style="letter-spacing: 5px;">ESTABLISHING TIMELINE...</div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div style="margin-top: 30px; opacity: 0.6; font-size: 0.8em;">Credits to - Ashen(@ashenthegreat3992)</div>
    </div>

    <div id="menu" class="screen">
        <div id="roblox-promo">Go follow the creator of this website on roblox, darkco281110!</div>
        <h1 id="title">THE BUTTERFLY LEDGER</h1>
        <div class="subtitle">btw this is a decision making game :)</div>
        
        <div style="display: flex;">
            <button class="main-btn" onclick="startFlow()">PLAY</button>
            <button class="main-btn" onclick="openLoadouts()">LOADOUTS</button>
        </div>
    </div>

    <div id="loadout-screen" class="screen">
        <h2 style="color:#00d4ff;">SAVED TIMELINES</h2>
        <div id="loadout-list"></div>
        <button class="main-btn" onclick="closeLoadouts()">BACK</button>
    </div>

    <button id="pause-btn" style="display:none;" onclick="location.reload()">l l</button>
    
    <div id="game-ui">
        <div class="panel" style="width: 450px; position: relative;">
            <div id="shift-label" style="color: #00d4ff; font-size: 0.8em; margin-bottom: 10px;">SHIFT 1</div>
            <div id="scenario-text" style="min-height: 80px; font-size: 1.2em;">Initializing...</div>
            
            <div id="outcome-overlay">
                <div id="outcome-status" style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;"></div>
                <div id="outcome-desc" style="color: #ccc; margin-bottom: 20px;"></div>
                <button class="main-btn" style="font-size: 0.7em; border-color: #00d4ff;" onclick="saveCurrentGame()">SAVE PROGRESS</button>
            </div>

            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="main-btn" style="flex:1; border-color:#00ff00;" onclick="handleChoice(true)">APPROVE</button>
                <button class="main-btn" style="flex:1; border-color:#ff0000;" onclick="handleChoice(false)">DENY</button>
            </div>
        </div>

        <div class="panel" style="width: 200px; text-align: right; align-self: flex-end;">
            <div style="font-size: 0.8em; color: #00d4ff;">STABILITY</div>
            <div id="stability-val" style="font-size: 2.5em; color: #00ffcc;">100%</div>
        </div>
    </div>

    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // --- DATA ---
        const Scenarios = [
            { text: "A local baker wants to reduce the price of bread by $2.", pos: "The people rejoiced at the affordable food; morale skyrocketed.", neg: "The baker went bankrupt, causing a massive bread shortage." },
            { text: "A scientist wants to release a colony of bio-luminescent bees.", pos: "The bees cross-pollinated endangered flora, saving the ecosystem.", neg: "The bees became an invasive species, killing all local pollinators." },
            { text: "A rogue AI wants access to the city's traffic light network.", pos: "Traffic flow became perfect, eliminating accidents entirely.", neg: "The AI caused a 400-car pileup to 'optimize' the population." },
            { text: "A child wants to plant a seed found in a meteor crater.", pos: "The tree produced fruit that cured minor illnesses.", neg: "The tree sprouted tentacles and began eating local pets." },
            { text: "A doctor wants to test an experimental 'memory-erasing' pill on trauma victims.", pos: "The victims found peace and rebuilt their lives successfully.", neg: "The pill erased all long-term memory, leaving patients as blank slates." }
        ];

        let state = { idx: 0, stability: 100, shift: 1, isProcessing: false };

        // --- THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const core = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 1), new THREE.MeshBasicMaterial({ color: 0x00d4ff, wireframe: true }));
        scene.add(core);
        const stars = new THREE.Points(new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(new Float32Array(9000).map(()=>(Math.random()-0.5)*70), 3)), new THREE.PointsMaterial({color: 0xffffff, size: 0.05}));
        scene.add(stars);
        camera.position.z = 6;

        function triggerFireball() {
            const fireball = new THREE.Mesh(new THREE.SphereGeometry(0.3, 8, 8), new THREE.MeshBasicMaterial({ color: 0xff4500 }));
            fireball.position.set((Math.random() > 0.5 ? 8 : -8), 8, -5);
            scene.add(fireball);
            const start = performance.now();
            function move(now) {
                const p = (now - start) / 600;
                if (p < 1) { fireball.position.lerp(new THREE.Vector3(0,0,0), p); requestAnimationFrame(move); }
                else { camera.position.x += (Math.random()-0.5); setTimeout(() => camera.position.set(0,0,6), 100); scene.remove(fireball); }
            }
            requestAnimationFrame(move);
        }

        // --- CORE FUNCTIONS ---
        window.startFlow = () => {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('loadout-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            document.getElementById('pause-btn').style.display = 'block';
            updateUI();
        };

        window.handleChoice = (approved) => {
            if(state.isProcessing) return;
            state.isProcessing = true;
            
            const isGood = Math.random() > 0.5;
            const correct = (approved && isGood) || (!approved && !isGood);
            const s = Scenarios[state.idx % Scenarios.length];

            if(!correct) triggerFireball();

            const overlay = document.getElementById('outcome-overlay');
            overlay.style.display = 'flex';
            document.getElementById('outcome-status').innerText = correct ? "STABILIZED" : "CAUSALITY FRACTURED";
            document.getElementById('outcome-status').style.color = correct ? "#00ff00" : "#ff0000";
            document.getElementById('outcome-desc').innerText = correct ? s.pos : s.neg;

            setTimeout(() => {
                overlay.style.display = 'none';
                state.stability = Math.max(0, Math.min(100, state.stability + (correct ? 5 : -15)));
                state.idx++;
                if(state.stability <= 0) { alert("REALITY COLLAPSED"); location.reload(); }
                updateUI();
                state.isProcessing = false;
            }, 3000);
        };

        window.saveCurrentGame = () => {
            const name = prompt("Name your Timeline:", "Save " + (state.idx + 1));
            if(!name) return;
            const saves = JSON.parse(localStorage.getItem('butterfly_ledger_saves') || "[]");
            saves.push({ name, state: JSON.parse(JSON.stringify(state)) });
            localStorage.setItem('butterfly_ledger_saves', JSON.stringify(saves));
            alert("Timeline Saved!");
        };

        window.openLoadouts = () => {
            const list = document.getElementById('loadout-list');
            list.innerHTML = "";
            const saves = JSON.parse(localStorage.getItem('butterfly_ledger_saves') || "[]");
            if(saves.length === 0) list.innerHTML = "<div style='opacity:0.5'>No saved timelines found.</div>";
            saves.forEach((s, i) => {
                const item = document.createElement('div');
                item.className = 'loadout-item';
                item.innerHTML = `<span><b>${s.name}</b> (Shift ${Math.floor(s.state.idx/10)+1})</span> 
                                  <button class="main-btn" style="padding:5px 15px; font-size:0.8em;" onclick="loadTimeline(${i})">LOAD</button>`;
                list.appendChild(item);
            });
            document.getElementById('menu').style.display = 'none';
            document.getElementById('loadout-screen').style.display = 'flex';
        };

        window.closeLoadouts = () => {
            document.getElementById('loadout-screen').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        };

        window.loadTimeline = (i) => {
            const saves = JSON.parse(localStorage.getItem('butterfly_ledger_saves') || "[]");
            const savedData = saves[i].state;
            // Overwrite current state with saved data
            state.idx = savedData.idx;
            state.stability = savedData.stability;
            state.shift = savedData.shift;
            state.isProcessing = false;
            
            startFlow(); // Enter the game
        };

        function updateUI() {
            const s = Scenarios[state.idx % Scenarios.length];
            document.getElementById('scenario-text').innerText = s.text;
            document.getElementById('stability-val').innerText = state.stability + "%";
            document.getElementById('shift-label').innerText = "SHIFT " + (Math.floor(state.idx/10)+1);
        }

        // --- INITIALIZER ---
        let lp = 0;
        const li = setInterval(() => {
            lp += 10;
            document.getElementById('progress-fill').style.width = lp + "%";
            if(lp >= 100) { clearInterval(li); document.getElementById('loader').style.display = 'none'; document.getElementById('menu').style.display = 'flex'; }
        }, 100);

        function animate() {
            requestAnimationFrame(animate);
            core.rotation.y += 0.01;
            stars.rotation.y += 0.0002;
            renderer.render(scene, camera);
        }
        animate();

        // Bind global functions for HTML buttons
        window.loadTimeline = loadTimeline;
    </script>
</body>
</html>